DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS restaurants CASCADE;
DROP TABLE IF EXISTS lunches CASCADE;
DROP TABLE IF EXISTS dishes CASCADE;
DROP TABLE IF EXISTS votes CASCADE;
DROP TABLE IF EXISTS user_roles CASCADE;
DROP TABLE IF EXISTS lunch_dish CASCADE;
DROP SEQUENCE IF EXISTS restaurant_seq CASCADE;
DROP SEQUENCE IF EXISTS user_seq CASCADE;
DROP SEQUENCE IF EXISTS lunch_seq CASCADE;
DROP SEQUENCE IF EXISTS dish_seq CASCADE;
DROP SEQUENCE IF EXISTS vote_seq CASCADE;

CREATE SEQUENCE restaurant_seq AS INTEGER START WITH 100;
CREATE SEQUENCE user_seq AS INTEGER START WITH 100;
CREATE SEQUENCE lunch_seq AS INTEGER START WITH 100;
CREATE SEQUENCE dish_seq AS INTEGER START WITH 100;
CREATE SEQUENCE vote_seq AS INTEGER START WITH 100;

CREATE TABLE restaurants (
  id      INTEGER GENERATED BY DEFAULT AS SEQUENCE restaurant_seq PRIMARY KEY,
  name    VARCHAR(255) NOT NULL,
  address VARCHAR(255) NOT NULL,
  phone   VARCHAR(255) DEFAULT NULL
);

CREATE TABLE users
(
  id         INTEGER GENERATED BY DEFAULT AS SEQUENCE user_seq PRIMARY KEY,
  name       VARCHAR(255) NOT NULL UNIQUE,
  email      VARCHAR(255) NOT NULL UNIQUE,
  password   VARCHAR(255) NOT NULL,
  registered TIMESTAMP DEFAULT now(),
  enabled    BOOLEAN DEFAULT TRUE
);
CREATE UNIQUE INDEX users_unique_email_idx ON users (email);

CREATE TABLE lunches
(
  id              INTEGER GENERATED BY DEFAULT AS SEQUENCE lunch_seq PRIMARY KEY,
  name            VARCHAR(255) NOT NULL,
  price           NUMERIC NOT NULL,
  restaurant_id   INTEGER NOT NULL,
  dateTime        TIMESTAMP DEFAULT NULL,
  FOREIGN KEY (restaurant_id) REFERENCES restaurants (id) ON DELETE CASCADE
);

CREATE TABLE dishes
(
  id              INTEGER GENERATED BY DEFAULT AS SEQUENCE dish_seq PRIMARY KEY,
  name            VARCHAR(255) NOT NULL,
  price           DECIMAL NOT NULL,
  restaurant_id   INTEGER NOT NULL ,
  FOREIGN KEY (restaurant_id) REFERENCES restaurants(id) ON DELETE CASCADE
);

CREATE TABLE votes
(
  id              INTEGER GENERATED BY DEFAULT AS SEQUENCE vote_seq PRIMARY KEY,
  vote_time       TIMESTAMP DEFAULT now(),
  user_id         INTEGER NOT NULL,
  restaurant_id   INTEGER NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
  FOREIGN KEY (restaurant_id) REFERENCES restaurants (id) ON DELETE CASCADE
);
CREATE INDEX vote_date ON votes (vote_time);

CREATE TABLE lunch_dish(
  lunch_id INTEGER NOT NULL,
  dish_id INTEGER NOT NULL,
  CONSTRAINT lunch_dish_idx UNIQUE (lunch_id, dish_id),
  FOREIGN KEY (lunch_id) REFERENCES lunches (id) ON DELETE CASCADE,
  FOREIGN KEY (dish_id) REFERENCES dishes (id) ON DELETE CASCADE
);

CREATE TABLE user_roles
(
  user_id INTEGER NOT NULL,
  role    VARCHAR(255),
  CONSTRAINT user_roles_idx UNIQUE (user_id, role),
  FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);


